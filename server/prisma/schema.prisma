// server/prisma/schema.prisma

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. USUARIOS (Admin y Profesores)
// ==========================================
model Usuario {
  id           Int      @id @default(autoincrement())
  nombre       String
  username     String   @unique
  password     String
  esAdmin      Boolean  @default(false)
  creadoEn     DateTime @default(now())
  salasCreadas Sala[]   @relation("ProfesorSalas")

  @@map("usuarios")
}

// ==========================================
// 2. SALAS DE JUEGO
// ==========================================
model Sala {
  id                Int      @id @default(autoincrement())
  codigo            String   @unique
  anfitrionId       Int
  anfitrion         Usuario  @relation("ProfesorSalas", fields: [anfitrionId], references: [id])
  
  // üî• CAMPO CR√çTICO: Aqu√≠ se guarda la posici√≥n de la ruleta y el orden
  datosJuego        Json?    
  
  creadaEn          DateTime @default(now())
  estado            String   @default("ACTIVA")

  faseActual        String   @default("lobby")
  timerCorriendo    Boolean  @default(false)
  segundosRestantes Int      @default(0)
  formacion         String   @default("manual") // "auto" o "manual"
  
  // Tiempos configurables
  t_rompehielo      Int      @default(180)
  t_diferencias     Int      @default(300)
  t_empatia         Int      @default(300)
  t_creatividad     Int      @default(900)
  t_pitch_prep      Int      @default(600)
  t_pitch_fuego     Int      @default(90)

  equipos           Equipo[]          @relation("SalaEquipos")
  eventos           EventoAnalitica[]

  @@map("salas")
}

// ==========================================
// 3. EQUIPOS (Alumnos)
// ==========================================
model Equipo {
  id                    Int      @id @default(autoincrement())
  nombre                String
  salaId                Int
  sala                  Sala     @relation("SalaEquipos", fields: [salaId], references: [id], onDelete: Cascade)

  puntos                Int      @default(0)
  
  desafioId             Int?    
  desafio               Desafio? @relation(fields: [desafioId], references: [id])
  
  // üî• CAMPO CR√çTICO: Para que el contador del profe suba
  listo                 Boolean  @default(false) 

  // üî• BLINDAJE: Textos largos para que no fallen
  mapaEmpatia           String?  @db.Text 
  feedbackData          String?  @db.Text

  // üî• BLINDAJE: Fotos (Base64 es GIGANTE, necesita LongText)
  fotoLegoUrl           String?  @db.LongText 
  
  integrantes           Integrante[]
  evaluacionesHechas    Evaluacion[] @relation("EvaluacionOrigen")
  evaluacionesRecibidas Evaluacion[] @relation("EvaluacionDestino")
  reflexiones           Reflexion[]
  eventos               EventoAnalitica[]

  @@unique([salaId, nombre])
  @@map("equipos")
}

model Integrante {
  id       Int     @id @default(autoincrement())
  nombre   String
  carrera  String?
  equipoId Int
  equipo   Equipo  @relation(fields: [equipoId], references: [id], onDelete: Cascade)

  @@map("integrantes")
}

// ==========================================
// 4. RESULTADOS Y DATOS
// ==========================================
model Evaluacion {
  id          Int      @id @default(autoincrement())
  createdAt   DateTime @default(now())
  origenId    Int
  origen      Equipo   @relation("EvaluacionOrigen", fields: [origenId], references: [id], onDelete: Cascade)
  destinoId   Int
  destino     Equipo   @relation("EvaluacionDestino", fields: [destinoId], references: [id], onDelete: Cascade)

  puntaje     Int
  detalleJson String   @db.Text 
  comentario  String?  @db.Text

  @@map("evaluaciones")
}

model Reflexion {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  equipoId  Int
  equipo    Equipo   @relation(fields: [equipoId], references: [id], onDelete: Cascade)
  texto     String   @db.Text 

  @@map("reflexiones")
}

model EventoAnalitica {
  id        Int      @id @default(autoincrement())
  timestamp DateTime @default(now())
  tipo      String
  fase      String?
  detalle   String?  @db.Text 
  salaId    Int
  sala      Sala     @relation(fields: [salaId], references: [id], onDelete: Cascade)
  equipoId  Int?     
  equipo    Equipo?  @relation(fields: [equipoId], references: [id], onDelete: SetNull)

  @@index([tipo, timestamp])
  @@map("eventos_analitica")
}

// ==========================================
// 5. CONFIGURACI√ìN ADMIN
// ==========================================
model Tema {
  id            String    @id
  label         String
  personaNombre String?
  personaBio    String?   @db.Text
  personaImg    String?   @db.LongText 

  desafios      Desafio[]

  @@map("temas")
}

model Desafio {
  id          Int    @id @default(autoincrement())
  titulo      String
  descripcion String @db.Text 
  imgUrl      String? @db.LongText 

  temaId      String
  tema        Tema   @relation(fields: [temaId], references: [id], onDelete: Cascade)
  equipos     Equipo[]

  @@map("desafios")
}

model OpcionRuleta {
  id          Int     @id @default(autoincrement())
  label       String
  descripcion String  @db.Text
  tipo        String
  delta       Int
  peso        Int
  color       String?

  @@map("config_ruleta")
}

model ItemChecklist {
  id       Int     @id @default(autoincrement())
  label    String
  valor    Int
  esFijo   Boolean @default(false)

  @@map("config_checklist")
}